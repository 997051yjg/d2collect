<!--pages/upload/upload.wxml-->
<view class="container">
  <!-- 搜索栏（粘性定位） -->
  <view class="search-wrapper animate-enter" bindtap="hideResultCard">
    <view class="search-bar {{isFocused ? 'focused' : ''}}" bindtap="preventCardHide">
      <icon type="search" size="20" color="{{isFocused ? 'var(--gold)' : '#666'}}"/>
      <input class="search-input" 
             placeholder="{{searchPlaceholder}}" 
             placeholder-class="ph"
             bindinput="onNameInput" 
             bindfocus="onFocus"
             bindblur="onBlur"
             bindconfirm="onSearchConfirm"
             bindkeydown="onSearchKeyDown"
             value="{{formData.name}}" />
    </view>
    
    <!-- 三角形切换按钮（使用catchtap阻止事件冒泡） -->
    <view class="toggle-btn {{searchResults.length > 0 ? 'active' : ''}}" 
          catchtap="toggleResultCard">
      <view class="triangle {{showResultCard ? 'up' : 'down'}}"></view>
    </view>

    <!-- 搜索状态指示器 -->
    <view class="search-status" wx:if="{{isSearching || searchError}}">
      <view class="search-loading" wx:if="{{isSearching}}">
        <view class="loading-dot"></view>
        <text class="status-text">搜索中...</text>
      </view>
      <view class="search-error" wx:if="{{searchError}}">
        <icon type="warn" size="16" color="var(--red-error)"/>
        <text class="status-text">{{searchError}}</text>
      </view>
    </view>

    <!-- 空状态提示 -->
    <view class="empty-state" wx:if="{{searchKeyword && searchResults.length === 0 && !isSearching}}">
      <icon type="search" size="48" color="#666"/>
      <text class="empty-text">未找到相关装备</text>
      <text class="empty-desc">尝试搜索其他关键词</text>
    </view>

    <!-- 搜索历史 -->
    <view class="search-history" wx:if="{{searchHistory.length > 0 && !searchKeyword && !isFocused}}">
      <view class="history-header">
        <text class="history-title">搜索历史</text>
        <text class="history-clear" bindtap="clearSearchHistory">清空</text>
      </view>
      <view class="history-list">
        <view class="history-item" 
              wx:for="{{searchHistory}}" 
              wx:key="*this"
              bindtap="selectHistoryItem"
              data-item="{{item}}">
          <icon type="time" size="16" color="#666"/>
          <text class="history-text">{{item}}</text>
        </view>
      </view>
    </view>
  </view>

  <!-- 搜索结果卡片 -->
  <view wx:if="{{showResultCard && searchResults.length > 0}}" class="result-card show" 
        bindtap="preventCardHide">
    <scroll-view class="card-content" scroll-y>
      <view class="equipment-grid">
        <view class="equipment-card {{selectedEquipment && selectedEquipment._id === item._id ? 'selected' : ''}} {{activeSearchIndex === index ? 'active' : ''}}" 
              wx:for="{{searchResults}}" 
              wx:key="_id"
              bindtap="selectEquipment"
              data-index="{{index}}">
          
          <!-- 竖向布局：图片、名称、品质、激活状态 -->
          <view class="card-layout">
            <!-- 装备图片 -->
            <view class="card-image">
              <image src="{{item.image || '/images/equipment-icons/default.png'}}" 
                     class="equipment-img" 
                     mode="aspectFit" />
            </view>
            
            <!-- 装备信息 - 竖向排列 -->
            <view class="card-info">
              <text class="equipment-name">{{item.name_zh || item.name}}</text>
              <text class="equipment-rarity {{item.rarity === '套装' ? 'suit' : 'unique'}}">{{item.rarity}}</text>
              <text class="status {{item.isActive ? 'activated' : 'not-activated'}}">{{item.isActive ? '已激活' : '未激活'}}</text>
            </view>
          </view>
          
          <!-- 选中效果 -->
          <view class="selection-indicator">
            <icon type="success" size="20" color="var(--gold)" />
          </view>
        </view>
      </view>
    </scroll-view>
  </view>

  <!-- 登录提示 -->
  <view class="login-prompt" wx:if="{{!isLoggedIn}}">
    <view class="login-prompt-card luxury-card animate-enter">
      <text class="login-prompt-title">需要登录</text>
      <text class="login-prompt-desc">请先登录后才能上传装备</text>
      <button class="btn-gold login-btn" bindtap="goToLogin">去登录</button>
    </view>
  </view>

  <block wx:if="{{selectedEquipment && isLoggedIn}}">
    <!-- 属性鉴定卡片 -->
    <view class="luxury-card animate-enter delay-1">
      <view class="card-header">
        <text class="card-title gold-text">属性鉴定</text>
        <text class="card-sub">{{selectedEquipment.name_zh || selectedEquipment.name}}</text>
      </view>
      
      <view class="attr-list">
        <block wx:for="{{selectedEquipment.attributes}}" wx:key="code">
          <view class="attr-row">
            <text class="attr-label">{{item.label}}</text>
            
            <view class="attr-input-box" wx:if="{{item.isVariable}}">
              <input class="attr-input" 
                     type="number" 
                     placeholder="{{item.min}}-{{item.max}}" 
                     placeholder-class="ph-small"
                     bindinput="onAttributeInput" 
                     data-code="{{item.code}}" />
            </view>
            <text class="attr-fixed" wx:else>{{item.min}}</text>
          </view>
        </block>
      </view>
    </view>

    <!-- 底部上传区域 -->
    <view class="footer-section animate-enter delay-2">
      <view class="upload-slot" bindtap="chooseImage">
        <image wx:if="{{uploadedImage}}" src="{{uploadedImage}}" class="slot-img" mode="aspectFit" />
        <view wx:else class="slot-placeholder">
          <text class="slot-icon">+</text>
          <text class="slot-text">上传截图</text>
        </view>
      </view>
      
      <button class="btn-gold submit-btn" bindtap="submitForm" loading="{{uploading}}">
        确认收录
      </button>
    </view>
  </block>

  <!-- 加载状态 -->
  <view class="loading" wx:if="{{loading}}">
    <view class="loading-spinner"></view>
    <text class="loading-text">加载中...</text>
  </view>
</view>