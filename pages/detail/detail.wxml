<view class="container theme-bg-diablo">
  <view class="bg-particles"></view>
  <view class="bg-texture"></view>

  <view wx:if="{{loading}}" class="loading-state center-screen">
    <view class="loading-spinner"></view>
    <text class="loading-text">æ­£åœ¨é‰´å®š...</text>
  </view>

  <view wx:elif="{{!equipment}}" class="empty-state center-screen">
    <text class="empty-title">æœªçŸ¥çš„åœ£ç‰©</text>
    <text class="empty-desc">è¯¥è£…å¤‡ä¼¼ä¹ä¸å±äºè¿™ä¸ªä½é¢ã€‚</text>
    <view class="btn-primary" bindtap="onBack">è¿”å›</view>
  </view>

  <view wx:else class="detail-content animate-enter">
    
    <view class="relic-showcase">
      <view class="relic-pedestal {{equipment.rarity === 'å¥—è£…' ? 'glow-green' : 'glow-gold'}}">
        <image class="relic-image" src="{{equipment.image || getEquipmentIcon(equipment.type)}}" mode="aspectFit" />
        <view class="pedestal-ring"></view>
      </view>

      <view class="relic-info">
        <text class="relic-name {{equipment.rarity === 'å¥—è£…' ? 'green-text' : 'gold-text'}}">{{equipment.name_zh || equipment.name}}</text>
        <text class="relic-en-name" wx:if="{{equipment.name_zh && equipment.name_zh !== equipment.name}}">{{equipment.name}}</text>
        
        <view class="relic-tags">
          <view class="rarity-pill">{{equipment.type}}</view>
          <view class="rarity-pill {{equipment.rarity === 'å¥—è£…' ? 'suit' : (equipment.rarity === 'ç¬¦æ–‡ä¹‹è¯­' ? 'runeword' : 'unique')}}">
            {{equipment.rarity}}
          </view>
          <view class="rarity-pill {{isActivated ? equipment.rarity === 'å¥—è£…' ? 'suit' : (equipment.rarity === 'ç¬¦æ–‡ä¹‹è¯­' ? 'runeword' : 'unique') : ''}}">
            {{isActivated ? 'å·²ç‚¹äº®' : 'æœªç‚¹äº®'}}
          </view>
        </view>
      </view>
    </view>

    <view class="section-card glass-card">
      <view class="section-header">
        <text class="section-title decorative-line">å±æ€§é“­æ–‡</text>
      </view>

      <view class="stats-list">
        <view class="stat-highlight" wx:if="{{equipment.stats}}">
          <text class="stat-main-value">{{equipment.stats}}</text>
        </view>
        
        <view class="stat-row fixed" wx:if="{{equipment.requiredLevel}}">
          <text class="stat-text">éœ€æ±‚ç­‰çº§: {{equipment.requiredLevel}}</text>
        </view>

        <block wx:for="{{equipment.attributes}}" wx:key="code">
          <view class="stat-row {{item.isVariable ? 'variable' : 'fixed'}}">
            <block wx:if="{{isActivated && item.userValue !== undefined}}">
               <view class="user-roll-container">
                 <text class="stat-text user-val">{{item.displayText}}</text>
                 <text class="roll-badge">Roll</text>
               </view>
            </block>
            <block wx:else>
               <text class="stat-text" style="color: {{item.displayColor}}">{{item.displayText}}</text>
            </block>
          </view>
        </block>

        <view class="no-stats" wx:if="{{!equipment.stats && (!equipment.attributes || equipment.attributes.length === 0)}}">
          <text>æ­¤ç‰©å“è•´å«ç€æœªçŸ¥çš„åŠ›é‡...</text>
        </view>
      </view>
    </view>

    <view class="section-card glass-card" wx:if="{{isActivated && userEquipment.images && userEquipment.images.length > 0}}">
      <view class="section-header">
        <text class="section-title decorative-line">å½±åƒè®°å½•</text>
      </view>
      
      <scroll-view class="gallery-scroll" scroll-x enable-flex>
        <view class="gallery-item" 
              wx:for="{{userEquipment.images}}" 
              wx:key="*this" 
              bindtap="viewImage" 
              data-index="{{index}}">
          <image src="{{item}}" mode="aspectFill" class="gallery-img"/>
        </view>
      </scroll-view>
    </view>

    <view class="collector-card glass-pill" wx:if="{{isActivated && userInfo}}">
      <image class="collector-avatar" src="{{userInfo.avatarUrl}}" mode="aspectFill" />
      <view class="collector-meta">
        <text class="collector-label">å‘ç°è€…</text>
        <text class="collector-name">{{userInfo.nickName}}</text>
      </view>
      <view class="collector-time">{{formattedTime || 'æœªçŸ¥æ—¶é—´'}}</view>
    </view>

    <view style="height: 180rpx;"></view>

  </view>

  <view class="action-bar glass-bar animate-slide-up" wx:if="{{!loading && equipment}}">
    <view class="action-btn icon-btn" bindtap="goToHome">
      <text class="action-icon">ğŸ </text>
      <text>å¤§å…</text>
    </view>
    
    <view class="action-btn icon-btn" bindtap="generateShareImage" wx:if="{{isActivated}}">
      <text class="action-icon">ğŸ“¸</text>
      <text>æµ·æŠ¥</text>
    </view>

    <view class="action-btn icon-btn" style="position: relative;" wx:if="{{isActivated}}">
      <button open-type="share" style="position: absolute; top:0; left:0; width:100%; height:100%; opacity: 0;"></button>
      <text class="action-icon">ğŸ’¬</text>
      <text>åˆ†äº«</text>
    </view>

    <view class="action-main-btn {{isOwner ? 'edit-mode' : 'upload-mode'}}" bindtap="goToUpload">
      <text class="main-btn-text">{{isActivated ? isOwner ? 'é‡æ–°é“­åˆ»' : 'æˆ‘ä¹Ÿè¦ç‚¹äº®' : isOwner ? 'é“­åˆ»è£…å¤‡' : 'æˆ‘ä¹Ÿè¦ç‚¹äº®'}}</text>
    </view>
  </view>

  <canvas 
    type="2d"
    id="shareCanvas" 
    style="width: 750rpx; height: 1200rpx; position: fixed; top: 0; left: -9999px;"
  ></canvas>

</view>